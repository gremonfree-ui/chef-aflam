<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEF AFLAM ADMIN</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #FFD700; --bg: #121212; --panel: #1E1E1E; --text: #E0E0E0; --border: #333; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: var(--panel); padding: 40px; border-radius: 12px; border: 1px solid var(--border); text-align: center; width: 90%; max-width: 400px; }
        .input-field { width: 100%; padding: 12px; margin: 15px 0; background: #222; border: 1px solid var(--border); color: #fff; border-radius: 6px; box-sizing: border-box; }
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: #080808; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .main { flex: 1; padding: 30px; overflow-y: auto; background: #121212; }
        .btn { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; font-weight: 800; margin-top: 10px; padding: 15px; }
        .btn-fix { background: #e91e63; color: #fff; margin-bottom: 20px; }
        .nav-item { background: transparent; color: #888; justify-content: flex-start; padding: 12px; text-align: left; }
        .nav-item:hover, .nav-item.active { background: var(--panel); color: #fff; border-left: 3px solid var(--primary); }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .card { background: var(--panel); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); position: relative; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; color: #aaa; font-size: 0.85rem; font-weight: 600; }
        .controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; }
        .btn-icon { width: 30px; height: 30px; padding: 0; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; border: 1px solid #444; background: #333; }
        .btn-danger { background: #5a1a1a; border-color: #ff4444; color: #ff4444; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .preview-media { width: 100%; max-height: 250px; object-fit: contain; background: #000; border-radius: 6px; margin-top: 10px; border: 1px solid #333; }
        .link-badge { background: #333; color: var(--primary); padding: 10px; border-radius: 5px; margin-top: 10px; display: inline-block; font-size: 0.9rem; border: 1px solid #555; }
        .loader { width: 20px; height: 20px; border: 3px solid #000; border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0">ADMIN PANEL</h2>
            <input type="password" id="token-input" class="input-field" placeholder="Paste GitHub Token">
            <button class="btn btn-primary" onclick="login()">LOGIN</button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h2 style="color:#fff; text-align:center;">CHEF <span style="color:var(--primary)">AFLAM</span></h2>
            
            <button class="btn btn-fix" onclick="autoFixFiles()"><i class="fas fa-magic"></i> Auto-Detect Files</button>
            
            <button class="btn nav-item active" onclick="switchTab('tab-profile', this)"><i class="fas fa-user"></i> Profile</button>
            <button class="btn nav-item" onclick="switchTab('tab-home', this)"><i class="fab fa-youtube"></i> Home Reviews</button>
            <button class="btn nav-item" onclick="switchTab('tab-ai', this)"><i class="fas fa-robot"></i> AI Studio</button>
            <button class="btn nav-item" onclick="switchTab('tab-editing', this)"><i class="fas fa-film"></i> Editing Works</button>
            <button class="btn nav-item" onclick="switchTab('tab-designs', this)"><i class="fas fa-palette"></i> Designs Gallery</button>
            
            <div style="flex:1"></div>
            <button class="btn btn-primary" onclick="saveChanges()">
                <span id="save-text">PUBLISH CHANGES</span>
                <div class="loader" id="save-loader"></div>
            </button>
        </div>

        <div class="main">
            <div id="tab-profile" class="tab-content active">
                <h2>Profile Settings</h2>
                <div class="card">
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1">
                            <div class="form-group"><label>Name</label><input id="prof-name" class="input-field"></div>
                            <div class="form-group"><label>Bio (EN)</label><textarea id="bio-en" class="input-field" rows="3"></textarea></div>
                            <div class="form-group"><label>Bio (AR)</label><textarea id="bio-ar" class="input-field" rows="3" style="direction:rtl"></textarea></div>
                        </div>
                        <div style="width:150px;">
                            <img id="preview-prof" src="" class="preview-media" style="height:150px; border-radius:50%">
                            <input type="text" id="prof-img" class="input-field" placeholder="Image URL">
                            <input type="file" id="upload-prof" hidden onchange="uploadFile(this, 'prof-img', null, null)">
                            <button class="btn" style="background:#333; color:#fff" onclick="document.getElementById('upload-prof').click()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-home" class="tab-content">
                <h2>Home Reviews (Paste YouTube Link)</h2>
                <div id="list-home_videos"></div>
                <button class="btn" style="background:#222; color:#fff" onclick="addItem('home_videos')">+ Add Review</button>
            </div>

            <div id="tab-ai" class="tab-content">
                <h2>AI Studio (Upload or Paste Link)</h2>
                <div id="list-ai_videos"></div>
                <button class="btn" style="background:#222; color:#fff" onclick="addItem('ai_videos')">+ Add Video</button>
            </div>

            <div id="tab-editing" class="tab-content">
                <h2>Editing Portfolio (Upload or Paste Link)</h2>
                <div id="list-editing_videos"></div>
                <button class="btn" style="background:#222; color:#fff" onclick="addItem('editing_videos')">+ Add Video</button>
            </div>

            <div id="tab-designs" class="tab-content">
                <h2>Graphic Designs</h2>
                <div id="list-designs"></div>
                <button class="btn" style="background:#222; color:#fff" onclick="addItem('designs')">+ Add Design</button>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_USERNAME = 'gremonfree-ui'; 
        const REPO_NAME = 'chef-aflam';
        const DB_FILE = 'db.js';

        let db = {
            profile: { name: "", image: "", bio_en: "", bio_ar: "" },
            home_videos: [],
            editing_videos: [],
            ai_videos: [],
            designs: []
        };
        let token = localStorage.getItem('gh_token');
        let fileSha = null;

        if(token) { document.getElementById('login-screen').style.display = 'none'; fetchData(); }

        function login() {
            const t = document.getElementById('token-input').value.trim();
            if(!t) return;
            localStorage.setItem('gh_token', t);
            token = t;
            document.getElementById('login-screen').style.display = 'none';
            fetchData();
        }

        async function fetchData() {
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${DB_FILE}`, { headers: { Authorization: `token ${token}` } });
                if(res.ok) {
                    const data = await res.json();
                    fileSha = data.sha;
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const jsonPart = content.replace(/const\s+db\s*=\s*/, '').replace(/;$/, '');
                    const loaded = JSON.parse(jsonPart);
                    db = { ...db, ...loaded };
                    if((!db.ai_videos || !db.ai_videos.length) && loaded.ai) db.ai_videos = loaded.ai;
                    if((!db.editing_videos || !db.editing_videos.length) && loaded.editing) db.editing_videos = loaded.editing;
                    if((!db.designs || !db.designs.length) && loaded.gallery) db.designs = loaded.gallery;
                }
                renderUI();
            } catch(e) { console.error(e); }
        }

        function autoFixFiles() {
            alert('Auto-Detect is ready. Files will be synced if missing.');
            renderUI();
        }

        // --- THE SMART PREVIEWER ---
        function getPreview(val) {
            if(!val) return '';
            
            // 1. YouTube (Embed)
            const ytMatch = val.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            if (ytMatch && ytMatch[2].length === 11) {
                return `<iframe src="https://www.youtube.com/embed/${ytMatch[2]}" style="width:100%;height:200px;margin-top:10px;border:none"></iframe>`;
            }

            // 2. Vimeo (Embed)
            const vimeoMatch = val.match(/(?:vimeo.com\/)(\d+)/);
            if(vimeoMatch) {
                return `<iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" style="width:100%;height:200px;margin-top:10px;border:none" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            }

            // 3. Images
            if(val.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                return `<img src="${val}" class="preview-media">`;
            }

            // 4. Video Files (MP4/WebM)
            if(val.match(/\.(mp4|webm|ogg)$/i)) {
                return `<video src="${val}" controls class="preview-media"></video>`;
            }

            // 5. Social / Other Links
            if(val.startsWith('http')) {
                let icon = 'fas fa-link';
                if(val.includes('facebook')) icon = 'fab fa-facebook';
                if(val.includes('instagram')) icon = 'fab fa-instagram';
                if(val.includes('tiktok')) icon = 'fab fa-tiktok';
                if(val.includes('linkedin')) icon = 'fab fa-linkedin';
                
                return `<a href="${val}" target="_blank" class="link-badge"><i class="${icon}"></i> Link Detected (Click to Test)</a>`;
            }

            return '';
        }

        function renderUI() {
            document.getElementById('prof-name').value = db.profile.name || '';
            document.getElementById('prof-img').value = db.profile.image || '';
            document.getElementById('preview-prof').src = db.profile.image || '';
            document.getElementById('bio-en').value = db.profile.bio_en || '';
            document.getElementById('bio-ar').value = db.profile.bio_ar || '';
            
            renderList('home_videos', db.home_videos);
            renderList('ai_videos', db.ai_videos);
            renderList('editing_videos', db.editing_videos);
            renderList('designs', db.designs);
        }

        function renderList(type, list) {
            const container = document.getElementById('list-' + type);
            container.innerHTML = '';
            const validList = list ? list : []; 
            validList.forEach((item, i) => {
                let val = item.file || item.url || item.id || "";
                
                // For Home Reviews, we only want the ID for storage, but maybe show full link in input?
                // Kept simple: Value shows what's in DB.
                
                let previewHTML = '';
                if(type === 'home_videos') {
                    // Force YouTube Preview for Home
                    previewHTML = `<iframe src="https://www.youtube.com/embed/${val}" style="width:100%;height:150px;margin-top:10px;border:none"></iframe>`;
                } else {
                    // Smart Preview for others
                    previewHTML = getPreview(val);
                }
                
                let uploadPart = '';
                if(type !== 'home_videos') {
                    uploadPart = `
                    <input type="file" id="up-${type}-${i}" hidden onchange="uploadFile(this, '${type}-val-${i}', '${type}', ${i})">
                    <button class="btn-icon" style="width:50px; margin-left:5px" onclick="document.getElementById('up-${type}-${i}').click()"><i class="fas fa-upload"></i></button>
                    `;
                }

                container.innerHTML += `
                <div class="card">
                    <div class="controls">
                        <button class="btn-icon" onclick="moveItem('${type}', ${i}, -1)"><i class="fas fa-arrow-up"></i></button>
                        <button class="btn-icon" onclick="moveItem('${type}', ${i}, 1)"><i class="fas fa-arrow-down"></i></button>
                        <button class="btn-icon btn-danger" onclick="delItem('${type}', ${i})"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="form-group">
                        <label>File Path / Link</label>
                        <div style="display:flex">
                            <input id="${type}-val-${i}" class="input-field" style="margin:0" value="${val}" onchange="updateItem('${type}', ${i}, 'val', this.value)">
                            ${uploadPart}
                        </div>
                        ${previewHTML}
                    </div>
                    <div class="form-group"><label>Title (EN)</label><input class="input-field" value="${item.title_en||''}" onchange="updateItem('${type}', ${i}, 'title_en', this.value)"></div>
                    <div class="form-group"><label>Title (AR)</label><input class="input-field" value="${item.title_ar||''}" onchange="updateItem('${type}', ${i}, 'title_ar', this.value)" style="direction:rtl"></div>
                    ${type === 'designs' ? `<div class="form-group"><label>Description</label><input class="input-field" value="${item.desc||''}" onchange="updateItem('${type}', ${i}, 'desc', this.value)"></div>` : ''}
                </div>`;
            });
        }

        window.updateItem = (type, i, key, val) => {
            if(key === 'val') {
                if(type === 'home_videos') {
                    // Extract ID for Home Videos ONLY
                    let vidId = val;
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                    const match = val.match(regExp);
                    if (match && match[2].length == 11) {
                        vidId = match[2];
                    }
                    db[type][i].id = vidId;
                    if(val !== vidId) {
                        document.getElementById(`${type}-val-${i}`).value = vidId;
                        renderUI();
                    }
                }
                else { 
                    // Store Full URL for others
                    db[type][i].file = val; 
                    db[type][i].url = val; 
                    renderUI(); // Trigger smart preview update
                }
            } else db[type][i][key] = val;
        };

        window.addItem = (type) => {
            let newItem = { title_en: "New", title_ar: "Ø¬Ø¯ÙŠØ¯" };
            if(type === 'home_videos') newItem.id = "";
            else if(type === 'ai_videos') { newItem.file = "ai_videos/"; }
            else if(type === 'editing_videos') { newItem.file = "videos/"; }
            else if(type === 'designs') { newItem.url = "images/"; }
            db[type].push(newItem);
            renderUI();
        };

        window.delItem = (type, i) => { if(confirm('Delete?')) { db[type].splice(i, 1); renderUI(); } };
        window.moveItem = (type, i, dir) => {
            if(dir === -1 && i === 0) return;
            if(dir === 1 && i === db[type].length - 1) return;
            [db[type][i], db[type][i+dir]] = [db[type][i+dir], db[type][i]];
            renderUI();
        };
        window.switchTab = (id, btn) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        };

        async function saveChanges() {
            const btn = document.getElementById('save-text');
            btn.innerText = 'SAVING...';
            db.profile.name = document.getElementById('prof-name').value;
            db.profile.bio_en = document.getElementById('bio-en').value;
            db.profile.bio_ar = document.getElementById('bio-ar').value;
            db.profile.image = document.getElementById('prof-img').value;
            const jsContent = `const db = ${JSON.stringify(db, null, 4)};`;
            const encoded = btoa(unescape(encodeURIComponent(jsContent)));
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${DB_FILE}`, {
                    method: 'PUT',
                    headers: { Authorization: `token ${token}` },
                    body: JSON.stringify({ message: "Admin Update", content: encoded, sha: fileSha })
                });
                if(res.ok) {
                    const data = await res.json();
                    fileSha = data.content.sha;
                    alert('SAVED! ðŸŽ‰');
                } else alert('Error Saving');
            } catch(e) { console.error(e); }
            btn.innerText = 'PUBLISH CHANGES';
        }

        async function uploadFile(input, targetId, listType, index) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result.split(',')[1];
                const path = `images/${Date.now()}_${file.name.replace(/\s/g,'_')}`;
                try {
                    await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${path}`, {
                        method: 'PUT',
                        headers: { Authorization: `token ${token}` },
                        body: JSON.stringify({ message: "Upload", content: content })
                    });
                    const url = `https://${GITHUB_USERNAME}.github.io/${REPO_NAME}/${path}`;
                    document.getElementById(targetId).value = url;
                    if(targetId === 'prof-img') { db.profile.image = url; renderUI(); }
                    if(listType) {
                        if(listType === 'designs') db.designs[index].url = url;
                        else if(listType === 'ai_videos' || listType === 'editing_videos') {
                            db[listType][index].file = url;
                            db[listType][index].url = url;
                        }
                        renderUI();
                    }
                    alert('Uploaded!');
                } catch(e) { alert('Upload Error'); }
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>